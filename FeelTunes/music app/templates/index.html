<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Music Player</h1>

        <form id="upload-form">
            <input type="file" name="file" required>
            <button type="submit">Upload</button>
        </form>

        <h2>Playlist</h2>
        <ul id="playlist">
            {% for song in playlist %}
            <li>
                {{ song }}
                <button onclick="playSong('{{ song }}')">Play</button>
                <button onclick="getMetadata('{{ song }}')">Metadata</button>
            </li>
            {% endfor %}
        </ul>

        <div class="controls">
            <h3>Current Track: <span id="current-track">None</span></h3>
            <button onclick="togglePause()">Pause/Resume</button>
            <button onclick="stopSong()">Stop</button>
            <button onclick="rewindSong()">Rewind</button>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="search-query" placeholder="Search for a track...">
        <button onclick="searchMusic()">Search</button>
    </div>
    
    <h2>Search Results</h2>
    <ul id="search-results"></ul>
    

    <script>
        // Fetch metadata
        function getMetadata(trackName) {
            fetch(`/metadata/${trackName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.metadata) {
                        console.log(data.metadata);
                        alert(`Metadata for ${trackName}:\n${JSON.stringify(data.metadata[0], null, 2)}`);
                    } else {
                        alert("No metadata found.");
                    }
                });
        }

        // Play song
        function playSong(filename) {
            fetch(`/play/${filename}`);
            document.getElementById('current-track').innerText = filename;
        }

        // Pause/Resume song
        function togglePause() {
            fetch('/pause');
        }

        // Stop song
        function stopSong() {
            fetch('/stop');
            document.getElementById('current-track').innerText = 'None';
        }

        // Rewind song
        function rewindSong() {
            fetch('/rewind');
        }

        // Upload song
        document.getElementById('upload-form').addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);

            fetch('/upload', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'File uploaded') {
                    const playlist = document.getElementById('playlist');
                    const li = document.createElement('li');
                    li.innerHTML = `
                        ${data.playlist[data.playlist.length - 1]} 
                        <button onclick="playSong('${data.playlist[data.playlist.length - 1]}')">Play</button>
                        <button onclick="getMetadata('${data.playlist[data.playlist.length - 1]}')">Metadata</button>
                    `;
                    playlist.appendChild(li);
                }
            });
        });

        function searchMusic() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert("Please enter a search query.");
                return;
            }

            fetch(`/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('search-results');
                    resultsContainer.innerHTML = '';

                    if (data.tracks) {
                        data.tracks.forEach(track => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${track.name}</strong> by ${track.artist} 
                                <button onclick="playTrack('${track.url}')">Play</button>
                                <button onclick="getMetadata('${track.name}')">Metadata</button>
                            `;
                            resultsContainer.appendChild(li);
                        });
                    } else {
                        resultsContainer.innerHTML = '<li>No results found.</li>';
                    }
                })
                .catch(error => console.error('Error fetching tracks:', error));
        }

        function playTrack(url) {
            window.open(url, '_blank');
        }


    </script>
</body>
</html>
